<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>店内マップ検索</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif; }
    header { position: sticky; top: 0; background: #fff; padding: 12px; border-bottom: 1px solid #E6E6E6; z-index: 10; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    input, select { padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 10px; }
    input { flex: 1; min-width: 220px; }
    select { min-width: 180px; background:#fff; }
    button { padding: 12px 14px; font-size: 16px; border: 0; border-radius: 10px; background:#111; color:#fff; }
    main { padding: 12px; }
    .mapWrap { position: relative; border-radius: 14px; overflow: hidden; border: 1px solid #eee; }
    .mapWrap img { width: 100%; display: block; user-select: none; -webkit-user-drag: none; }
    .pin {
      position: absolute;
      transform: translate(-50%, -100%);
      background: #FF2D55;
      color: #fff;
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 14px;
      white-space: nowrap;
      box-shadow: 0 10px 25px rgba(0,0,0,.18);
    }
    .pin:after{
      content:"";
      position:absolute;
      left:50%;
      bottom:-8px;
      transform:translateX(-50%);
      border:8px solid transparent;
      border-top-color:#ff2d55;
    }
    .meta { margin-top: 10px; color:#333; line-height: 1.6; }
    .hint { color:#666; font-size: 13px; margin-top: 6px;}
    .list { margin-top: 12px; display: grid; gap: 8px; }
    .card { padding: 10px 12px; border: 1px solid #eee; border-radius: 12px; background:#fff; }
    .card strong { display:block; font-size: 16px; }
    .small { color:#666; font-size: 13px; margin-top: 2px; }
    .pill { display:inline-block; font-size: 12px; padding: 4px 8px; border: 1px solid #eee; border-radius: 999px; margin-right: 6px; }
  </style>
</head>
<body>
<header>
  <div class="row">
    <input id="q" placeholder="商品名 / カテゴリ / ブランドで検索（例：牛乳 / 乳製品 / 明治）" autocomplete="off" />
    <select id="mode" title="検索範囲">
      <option value="all">全部（商品名＋カテゴリ＋ブランド＋別名）</option>
      <option value="name">商品名</option>
      <option value="category">カテゴリ</option>
      <option value="brand">ブランド</option>
      <option value="keywords">別名（keywords）</option>
    </select>
    <button id="btn">検索</button>
    <button id="refresh" style="background:#444;">再読込</button>
    <button id="scan" style="background:#0a7;">QRで読み取る</button>
  </div>
  <div class="hint">検索で複数ヒットした場合、下の候補一覧をタップするとピン表示が切り替わります（iPad運用想定）</div>
</header>

<main>
  <div class="mapWrap" id="mapWrap">
    <img src="./map.jpg" alt="店内マップ" />
  </div>
  <div class="meta" id="meta"></div>
  <div class="list" id="list"></div>
</main>

<!-- QRスキャン用モーダル -->
<div id="scanModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.65); z-index:9999;">
  <div style="position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); width:min(92vw,520px); background:#fff; border-radius:14px; overflow:hidden;">
    <div style="display:flex; justify-content:space-between; align-items:center; padding:10px 12px; border-bottom:1px solid #eee;">
      <strong>QRコード読み取り</strong>
      <button id="scanClose" style="border:0; background:#444; color:#fff; border-radius:10px; padding:8px 10px;">閉じる</button>
    </div>

    <div style="padding:12px;">
      <video id="scanVideo" playsinline autoplay muted
        style="width:100%; height:260px; border-radius:12px; background:#000; object-fit:cover;"></video>
      <div id="scanMsg" style="margin-top:10px; font-size:13px; color:#555;">
        カメラを起動します。許可してください。
      </div>
    </div>
  </div>
</div>

<script>
  // ▼あなたのApps Script WebアプリURL
  const API_URL = "https://script.google.com/macros/s/AKfycbx1qC57Bm_ypQJGSNGG8UnHL_KatQncBCNPAjtaK7d5ETO__AHqIu5LV_WrqN_oA6D_gw/exec";

  let items = [];
  let lastFound = [];
  const $ = (id) => document.getElementById(id);

  function norm(s){ return (s ?? "").toString().trim().toLowerCase(); }
  function buildIndex(row){
    return [row.name, row.category, row.brand, row.keywords, row.area, row.note].map(norm).join(" ");
  }

  async function loadItems({force=false}={}){
    const res = await fetch(API_URL, { cache: force ? "no-store" : "default" });
    if(!res.ok) throw new Error("API error: " + res.status);
    const data = await res.json();
    if(!data.items) throw new Error("Invalid JSON shape");
    items = data.items.map(r => ({...r, _index: buildIndex(r)}));
    return items;
  }

  function clearPins(){ document.querySelectorAll(".pin").forEach(el => el.remove()); }

  function addPin(row){
    const wrap = $("mapWrap");
    const pin = document.createElement("div");
    pin.className = "pin";
    pin.textContent = `${row.name ?? "(名称なし)"}（${row.area ?? "場所未設定"}）`;
    pin.style.left = `${Number(row.x)}%`;
    pin.style.top  = `${Number(row.y)}%`;
    wrap.appendChild(pin);
  }

  function renderList(found){
    const list = $("list");
    list.innerHTML = "";
    found.slice(0, 12).forEach((row, i) => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <strong>${row.name ?? "(名称なし)"}</strong>
        <div class="small">
          <span class="pill">${row.category ?? "カテゴリ未設定"}</span>
          <span class="pill">${row.brand ?? "ブランド未設定"}</span>
        </div>
        <div class="small">場所：${row.area ?? "-"} / 座標：${row.x ?? "-"}, ${row.y ?? "-"}</div>
      `;
      div.addEventListener("click", () => focusResult(i));
      list.appendChild(div);
    });
  }

  function focusResult(index){
    const row = lastFound[index];
    if(!row) return;
    clearPins();
    addPin(row);
    $("meta").innerHTML =
      `見つかった商品：<b>${row.name ?? "-"}</b><br>` +
      `カテゴリ：${row.category ?? "-"} / ブランド：${row.brand ?? "-"}<br>` +
      `場所：${row.area ?? "-"}${row.note ? "（" + row.note + "）" : ""}`;
  }

  function search(){
    const q = norm($("q").value);
    const mode = $("mode").value;
    clearPins();
    $("meta").textContent = "";
    $("list").innerHTML = "";

    if(!q){
      $("meta").textContent = "検索キーワードを入力してください。";
      return;
    }

    const found = items.filter(r => {
      if(mode === "name") return norm(r.name).includes(q);
      if(mode === "category") return norm(r.category).includes(q);
      if(mode === "brand") return norm(r.brand).includes(q);
      if(mode === "keywords") return norm(r.keywords).includes(q);
      return r._index.includes(q);
    });

    if(found.length === 0){
      $("meta").textContent = `「${q}」に一致する商品が見つかりませんでした。`;
      return;
    }

    lastFound = found;
    focusResult(0);
    renderList(found);
  }

  async function init(force=false){
    try{
      $("meta").textContent = "データ読み込み中…";
      await loadItems({force});
      $("meta").textContent = "準備OK。検索してください。";
    }catch(e){
      console.error(e);
      $("meta").textContent = "データ取得に失敗しました。API URLと公開設定を確認してください。";
    }
  }

  $("btn").addEventListener("click", search);
  $("refresh").addEventListener("click", () => init(true));
  $("q").addEventListener("keydown", (e) => { if(e.key === "Enter") search(); });

  // === QRスキャン（カメラ + QR読取）===
  const scanModal = document.getElementById("scanModal");
  const scanClose = document.getElementById("scanClose");
  const scanVideo = document.getElementById("scanVideo");
  const scanMsg   = document.getElementById("scanMsg");

  let scanStream = null;
  let scanTimer = null;
  let scanning = false; // ★重要：グローバル

  function setMsg(t){ scanMsg.textContent = t; }

  async function startCamera(){
    scanStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    scanVideo.srcObject = scanStream;
    await scanVideo.play();
  }

  function stopCamera(){
    if (scanTimer) { clearInterval(scanTimer); scanTimer = null; }
    if (scanStream) {
      scanStream.getTracks().forEach(t => t.stop());
      scanStream = null;
    }
    scanVideo.srcObject = null;
  }

  async function scanLoop(){
    if (!("BarcodeDetector" in window)) {
      setMsg("この環境ではQR読取（BarcodeDetector）が使えません。Safari/iPadOSの対応状況により動作しない場合があります。");
      return;
    }

    const detector = new BarcodeDetector({ formats: ["qr_code"] });
    setMsg("QRコードを枠内に写してください…");
    scanning = true;

    scanTimer = setInterval(async () => {
      if (!scanning) return;
      try{
        if (!scanVideo || scanVideo.readyState < 2) return;
        const barcodes = await detector.detect(scanVideo);
        if (barcodes && barcodes.length > 0) {
          const value = (barcodes[0].rawValue || "").trim();
          if (!value) return;

          scanning = false;
          $("q").value = value;
          closeScanModal();
          search();
        }
      }catch(e){
        // 検出失敗は無視（毎フレーム起こり得る）
      }
    }, 250);
  }

  async function openScanModal(){
    stopCamera();
    scanModal.style.display = "block";
    setMsg("カメラを起動します。許可してください。");

    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      setMsg("この環境ではカメラAPIが利用できません。");
      return;
    }

    try{
      setMsg("カメラを起動中…");
      await startCamera();
      await scanLoop();
    }catch(e){
      console.error(e);
      setMsg("カメラの起動に失敗しました。権限（カメラ許可）をご確認ください。");
      stopCamera();
    }
  }

  function closeScanModal(){
    scanning = false;
    scanModal.style.display = "none";
    stopCamera();
    setMsg("");
  }

  document.getElementById("scan").addEventListener("click", openScanModal);
  scanClose.addEventListener("click", closeScanModal);
  scanModal.addEventListener("click", (e) => { if(e.target === scanModal) closeScanModal(); });

  // PWA登録
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }

  init(false);
</script>
</body>
</html>
